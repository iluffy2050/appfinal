<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Global Chat</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/134/134914.png">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0078ff;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    #chat {
      height: 400px;
      overflow-y: auto;
      padding: 15px;
      background: white;
    }
    .message {
      display: flex;
      align-items: flex-end;
      margin: 10px;
      max-width: 70%;
    }
    .message .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    .bubble {
      padding: 10px 14px;
      border-radius: 12px;
      margin: 0 8px;
      background: #e4e6eb;
      color: black;
    }
    .sent {
      margin-left: auto;
      flex-direction: row-reverse;
    }
    .sent .bubble {
      background: #0078ff;
      color: white;
    }
    #typing {
      font-style: italic;
      color: gray;
      margin: 5px 15px;
    }
    #seen {
      font-size: 12px;
      color: gray;
      text-align: right;
      margin: 5px 15px;
    }
    #input-area {
      display: flex;
      padding: 10px;
      background: #f9f9f9;
    }
    #message {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }
    #sendBtn {
      background: #0078ff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      margin-left: 5px;
      cursor: pointer;
    }
    #notify {
      position: absolute;
      top: 8px;
      right: 12px;
      background: red;
      color: white;
      font-size: 12px;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
    }
  </style>
</head>
<body>

<header>
  üåç Global Chat
  <span id="notify">0</span>
</header>

<div style="padding:10px;">
  Username: <input type="text" id="username" placeholder="Your name">
  PFP URL: <input type="text" id="pfp" placeholder="Profile picture URL">
  <button onclick="joinChat()">Join</button>
</div>

<div id="chat"></div>
<div id="typing"></div>
<div id="seen"></div>

<div id="input-area">
  <input type="text" id="message" placeholder="Type a message..." oninput="typing()" onkeypress="checkEnter(event)">
  <button id="sendBtn" onclick="sendMessage()">Send</button>
</div>

<script>
let socket;
let joined = false;
let myUsername = "";
let notifyCount = 0;

function joinChat() {
  myUsername = document.getElementById('username').value;
  const pfp = document.getElementById('pfp').value || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  if (!myUsername) return alert("Enter a username");

  socket = io({transports: ['polling']});


  socket.on('connect', () => {
    socket.emit('join', {username: myUsername, pfp: pfp});
    joined = true;
  });

  socket.on('receive_message', data => {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.classList.add('message');
    if (data.username === myUsername) {
      div.classList.add('sent');
    } else {
      div.classList.add('received');
      notifyCount++;
      document.getElementById('notify').style.display = "flex";
      document.getElementById('notify').innerText = notifyCount;
    }

    div.innerHTML = `
      <img src="${data.pfp}" class="avatar">
      <div class="bubble">${data.username}: ${data.text}</div>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;

    // auto mark as seen when I scroll
    socket.emit('seen');
  });

  socket.on('user_typing', data => {
    document.getElementById('typing').innerText = `${data.username} is typing...`;
    setTimeout(() => { document.getElementById('typing').innerText = ''; }, 1000);
  });

  socket.on('seen_message', data => {
    document.getElementById('seen').innerText = `Seen by ${data.username}`;
  });
}

function sendMessage() {
  const msg = document.getElementById('message').value;
  if (msg && joined) {
    socket.emit('send_message', {message: msg});
    document.getElementById('message').value = '';
  }
}

function typing() {
  if (joined) socket.emit('typing');
}

function checkEnter(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
}
</script>

</body>
</html>

