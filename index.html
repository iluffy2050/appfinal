<input type="text" id="username" placeholder="Your name">
<input type="text" id="pfp" placeholder="Profile picture URL">

<div id="chat"></div>
<div id="typing"></div>

<input type="text" id="message" placeholder="Type a message..." oninput="sendTyping()">
<button onclick="sendMessage()">Send</button>

<script>
function requestNotificationPermission() {
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }
}
let username = '';
let pfp = '';

document.getElementById('username').addEventListener('change', ()=> {
    username = document.getElementById('username').value;
    pfp = document.getElementById('pfp').value;
    requestNotificationPermission();
});


function sendMessage(){
    const msg = document.getElementById('message').value;
    if(!username||!msg) return;
    fetch('/send', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username, pfp, message:msg})
    });
    document.getElementById('message').value='';
}

// Send typing info
function sendTyping(){
    if(!username) return;
    fetch('/typing', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username})
    });
}

// Poll messages

let lastMessageCount = 0;

async function fetchMessages(){
    if(!username) return;
    const res = await fetch('/get_messages', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username})
    });
    const data = await res.json();
    const chat = document.getElementById('chat');
    chat.innerHTML='';
    data.forEach(msg=>{
        const div=document.createElement('div');
        div.className='message';
        let seen = msg.seen_count>1? ` (Seen by ${msg.seen_count})` : '';
        div.innerHTML=`<img src="${msg.pfp}" class="pfp">${msg.username}: ${msg.message}${seen}`;
        chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;

    // Check for new messages to trigger notification
    if (data.length > lastMessageCount) {
        const newMsgs = data.slice(lastMessageCount);
        newMsgs.forEach(msg => {
            if (msg.username !== username && Notification.permission === "granted") {
                new Notification(`New message from ${msg.username}`, {
                    body: msg.message,
                    icon: msg.pfp || ''
                });
            }
        });
        // Update tab title with +N
        document.title = `(+${data.length - lastMessageCount}) Global Chat`;
    }
    lastMessageCount = data.length;
}
window.addEventListener('focus', ()=>{
    document.title = 'Global Chat';
});


// Poll typing
async function fetchTyping(){
    const res = await fetch('/get_typing');
    const users = await res.json();
    const typingDiv = document.getElementById('typing');
    typingDiv.innerText = users.length ? users.join(', ')+' is typing...' : '';
}

// Poll every second
setInterval(fetchMessages,1000);
setInterval(fetchTyping,1000);
</script>
