<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Chat</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/134/134914.png"> <!-- ðŸŒŽ example logo -->
<style>
body {
    font-family: Arial, sans-serif; 
    background:#121212; 
    color:white; 
    margin:0; 
    padding:0; 
    display:flex; 
    flex-direction:column; 
    height:100vh;
}
header {
    background:#1f1f1f;
    padding:12px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
    border-bottom:1px solid #333;
}
#chat {
    flex:1;
    overflow-y:auto;
    padding:10px;
    background:#181818;
}
.message {
    display:flex;
    margin:8px 0;
    max-width:70%;
}
.message.left {
    justify-content:flex-start;
}
.message.right {
    justify-content:flex-end;
}
.bubble {
    padding:10px 14px;
    border-radius:18px;
    line-height:1.3;
    position:relative;
}
.left .bubble {
    background:#2c2c2c;
    border-bottom-left-radius:4px;
}
.right .bubble {
    background:#4a90e2;
    border-bottom-right-radius:4px;
}
.username {
    font-size:12px;
    opacity:0.7;
    margin-bottom:3px;
}
#typing {
    font-style: italic; 
    color: lightgray; 
    margin: 5px 12px;
}
input, button {
    padding:10px; 
    margin:6px; 
    border-radius:6px; 
    border:none;
}
#inputArea {
    background:#1f1f1f;
    padding:10px;
    display:flex;
    align-items:center;
}
#message {
    flex:1;
    margin-right:6px;
}
button {
    background:#4a90e2; 
    color:white; 
    cursor:pointer;
}
button:hover {
    background:#357ABD;
}
</style>
</head>
<body>

<header>ðŸŒŽ Global Chat</header>

<div id="chat"></div>
<div id="typing"></div>

<div id="inputArea">
    <input type="text" id="username" placeholder="Your name" style="max-width:120px;">
    <input type="text" id="pfp" placeholder="Profile picture URL" style="max-width:160px;">
    <button onclick="joinChat()">Join</button>
</div>

<div id="inputArea">
    <input type="text" id="message" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
</div>

<script>
let username="", pfp="";
let lastMessageCount=0;

function requestNotificationPermission() {
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }
}

function joinChat(){
    username=document.getElementById('username').value.trim();
    pfp=document.getElementById('pfp').value.trim();
    if(!username) return alert("Enter a username");
    requestNotificationPermission();
    pollMessages();
    setInterval(pollMessages,1000);

    // typing listener
    document.getElementById('message').addEventListener('input', ()=>{
        fetch('/typing', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username})
        });
    });

    // enter to send
    document.getElementById('message').addEventListener('keypress', function(e){
        if(e.key==="Enter"){
            e.preventDefault();
            sendMessage();
        }
    });
}

async function pollMessages(){
    if(!username) return;
    const res=await fetch('/get_messages',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username})
    });
    const data=await res.json();
    const chat=document.getElementById('chat');
    chat.innerHTML='';
    data.messages.forEach(msg=>{
        const div=document.createElement('div');
        div.className='message ' + (msg.username===username? 'right':'left');
        
        let seen = msg.seen_by && msg.seen_by!==msg.username ? 
            `<div style="font-size:11px;opacity:0.6;margin-top:2px;">Seen by ${msg.seen_by}</div>` 
            : '';

        div.innerHTML=`
            <div class="bubble">
                <div class="username">${msg.username}</div>
                ${msg.message}
                ${seen}
            </div>`;
        chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;

    // notifications
    if(data.messages.length > lastMessageCount){
        const newMsgs = data.messages.slice(lastMessageCount);
        newMsgs.forEach(m=>{
            if(m.username!==username && Notification.permission==="granted"){
                new Notification(`New message from ${m.username}`,{
                    body:m.message,
                    icon:m.pfp || ''
                });
            }
        });
        document.title=`(+${data.messages.length-lastMessageCount}) Global Chat`;
    }
    lastMessageCount=data.messages.length;

    // typing indicator
    document.getElementById('typing').innerText = data.typing && data.typing!==username
        ? `${data.typing} is typing...` : '';
}

async function sendMessage(){
    const msg=document.getElementById('message').value.trim();
    if(!msg || !username) return;
    await fetch('/send_message',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username,pfp,message:msg})
    });
    document.getElementById('message').value="";
    pollMessages();
}

window.addEventListener('focus', ()=>{ document.title="Global Chat"; });
</script>

</body>
</html>
